---
import { DEFAULT_LOCALE } from '@/constants';
import {
  useTranslations,
  getBreadcrumbList,
  getCurrentLocale,
  getLocalizedHref,
} from '@/utils/i18n';

const locale = getCurrentLocale(Astro);
const t = useTranslations(locale);

const breadcrumbList = getBreadcrumbList(Astro.url.pathname);

// 路径名翻译映射
const pathTranslations: Record<string, string> = {
  posts: t('nav.posts'),
  tags: t('nav.tags'),
  archives: t('nav.archives'),
  search: t('nav.search'),
  about: t('nav.about'),
};

// if breadcrumb is Home > Posts > 1 <etc>
// replace Posts with Posts (page number)
if (breadcrumbList[0] === 'posts') {
  const pageNum = breadcrumbList[1] || 1;
  const pageText =
    locale === DEFAULT_LOCALE
      ? `${t('nav.posts')} (${t('breadcrumb.page')} ${pageNum} ${t('breadcrumb.pageSuffix')})`
      : `${t('nav.posts')} (${t('breadcrumb.page')} ${pageNum})`;
  breadcrumbList.splice(0, 2, pageText);
}

// if breadcrumb is Home > Tags > [tag] > [page] <etc>
// replace [tag] > [page] with [tag] (page number)
if (breadcrumbList[0] === 'tags' && !isNaN(Number(breadcrumbList[2]))) {
  const pageNum = breadcrumbList[2];
  const pageText =
    Number(pageNum) === 1
      ? ''
      : locale === DEFAULT_LOCALE
        ? ` (${t('breadcrumb.page')} ${pageNum} ${t('breadcrumb.pageSuffix')})`
        : ` (${t('breadcrumb.page')} ${pageNum})`;
  breadcrumbList.splice(1, 3, `${breadcrumbList[1]}${pageText}`);
}

// 翻译路径名
const translatedBreadcrumbs = breadcrumbList.map((crumb) => pathTranslations[crumb] || crumb);
---

<nav class="app-layout mt-8 mb-1" aria-label="breadcrumb">
  <ul class="font-light [&>li]:inline [&>li:not(:last-child)>a]:hover:opacity-100">
    <li>
      <a href={getLocalizedHref(locale, '/')} class="opacity-80">
        {t('breadcrumb.home')}
      </a>
      <span aria-hidden="true" class="opacity-80">&raquo;</span>
    </li>
    {
      breadcrumbList.map((breadcrumb, index) => {
        const displayText = translatedBreadcrumbs[index];
        return index + 1 === breadcrumbList.length ? (
          <li>
            <span
              class:list={['capitalize opacity-75', { lowercase: index > 0 }]}
              aria-current="page"
            >
              {/* make the last part lowercase in Home > Tags > some-tag */}
              {decodeURIComponent(displayText)}
            </span>
          </li>
        ) : (
          <li>
            <a href={getLocalizedHref(locale, `/${breadcrumb}/`)} class="capitalize opacity-70">
              {displayText}
            </a>
            <span aria-hidden="true">&raquo;</span>
          </li>
        );
      })
    }
  </ul>
</nav>
