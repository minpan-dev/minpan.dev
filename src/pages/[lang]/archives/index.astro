---
import { getCollection } from 'astro:content';
import Main from '@/layouts/Main.astro';
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import Card from '@/components/Card.astro';
import getPostsByGroupCondition from '@/utils/getPostsByGroupCondition';
import { SITE } from '@/config';
import { useTranslations, getCurrentLocale, getLangStaticPaths } from '@/utils/i18n';
import { DEFAULT_LOCALE, LOCALE_LIST } from '@/constants';
import getSortedPosts from '@/utils/getSortedPosts';

export const getStaticPaths = getLangStaticPaths;

const locale = getCurrentLocale(Astro);
const t = useTranslations(locale);

// Redirect to 404 page if `showArchives` config is false
if (!SITE.showArchives) {
  return Astro.redirect('/404');
}

const allPosts = await getCollection('blog', ({ data }) => !data.draft);

let posts;
if (locale === DEFAULT_LOCALE) {
  posts = allPosts.filter((post) =>
    post.id.toLowerCase().startsWith(`${DEFAULT_LOCALE.toLowerCase()}/`),
  );
} else {
  const postsMap = new Map();
  allPosts.forEach((post) => {
    const baseId = post.id.replace(new RegExp(`^(${LOCALE_LIST.join('|')})\\/`, 'i'), '');
    if (!postsMap.has(baseId) || post.id.startsWith(`${locale}/`)) {
      postsMap.set(baseId, post);
    }
  });
  posts = Array.from(postsMap.values());
}

const sortedPosts = getSortedPosts(posts);
const months = t('archives.months');
---

<Layout title={`Archives | ${t('site.title')}`}>
  <Header />
  <Main pageDesc={t('archives.pageDesc')}>
    {
      Object.entries(
        getPostsByGroupCondition(sortedPosts, (post) => post.data.pubDatetime.getFullYear()),
      )
        .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
        .map(([year, yearGroup]) => (
          <div>
            <span class="text-2xl font-bold">{year}</span>
            <sup class="text-sm">{yearGroup.length}</sup>
            {Object.entries(
              getPostsByGroupCondition(yearGroup, (post) => post.data.pubDatetime.getMonth() + 1),
            )
              .sort(([monthA], [monthB]) => Number(monthB) - Number(monthA))
              .map(([month, monthGroup]) => (
                <div class="flex flex-col sm:flex-row">
                  <div class="mt-6 min-w-36 text-lg sm:my-6">
                    <span class="font-bold">{months[Number(month) - 1]}</span>
                    <sup class="text-xs">{monthGroup.length}</sup>
                  </div>
                  <ul>
                    {monthGroup
                      .sort(
                        (a, b) =>
                          Math.floor(new Date(b.data.pubDatetime).getTime() / 1000) -
                          Math.floor(new Date(a.data.pubDatetime).getTime() / 1000),
                      )
                      .map((data) => (
                        <Card {...data} />
                      ))}
                  </ul>
                </div>
              ))}
          </div>
        ))
    }
  </Main>
  <Footer />
</Layout>
